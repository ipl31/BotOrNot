name: .NET Core Desktop

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  build:
    strategy:
      matrix:
        configuration: [Debug, Release]

    runs-on: windows-latest

    env:
      Solution_Name: BotOrNot
      Test_Project_Path: BotOrNot\BotOrNot.csproj
      # ⬇️ set these to your actual WAP (MSIX) project, not placeholders
      Wap_Project_Directory: BotOrNot.Package
      Wap_Project_Path: BotOrNot.Package\BotOrNot.Package.wapproj
      # computed: if both secrets exist => 'true', else 'false'
      SIGNING_ENABLED: ${{ secrets.Base64_Encoded_Pfx != '' && secrets.Pfx_Key != '' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 9.0.x

      - name: Setup MSBuild.exe
        uses: microsoft/setup-msbuild@v2

      - name: Execute unit tests
        run: dotnet test

      - name: Restore the application
        run: msbuild $env:Solution_Name /t:Restore /p:Configuration=$env:Configuration
        env:
          Configuration: ${{ matrix.configuration }}
      
      # Decode PFX only if secrets exist
      - name: Decode the pfx
        if: env.SIGNING_ENABLED == 'true'
        shell: pwsh
        run: |
          $pfxBytes = [Convert]::FromBase64String("${{ secrets.Base64_Encoded_Pfx }}")
          $certificatePath = Join-Path $env:Wap_Project_Directory 'GitHubActionsWorkflow.pfx'
          New-Item -ItemType Directory -Force -Path $env:Wap_Project_Directory | Out-Null
          [IO.File]::WriteAllBytes($certificatePath, $pfxBytes)
      
      # Signed build (only when secrets exist)
      - name: Create the app package (SIGNED)
        if: env.SIGNING_ENABLED == 'true'
        shell: pwsh
        run: >
          msbuild $env:Wap_Project_Path
          /p:Configuration=${{ matrix.configuration }}
          /p:UapAppxPackageBuildMode=StoreUpload
          /p:AppxBundle=Always
          /p:Appx_Bundle_Platforms="x86|x64"
          /p:PackageCertificateKeyFile=GitHubActionsWorkflow.pfx
          /p:PackageCertificatePassword=${{ secrets.Pfx_Key }}
      
      # Unsigned build (skip signing when secrets are missing)
      - name: Create the app package (UNSIGNED)
        if: env.SIGNING_ENABLED != 'true'
        shell: pwsh
        run: >
          msbuild $env:Wap_Project_Path
          /p:Configuration=${{ matrix.configuration }}
          /p:UapAppxPackageBuildMode=CI
          /p:AppxBundle=Always
          /p:Appx_Bundle_Platforms="x86|x64"
          /p:AppxPackageSigningEnabled=false
      
      # Remove the pfx only if we created it
      - name: Remove the pfx
        if: env.SIGNING_ENABLED == 'true'
        shell: pwsh
        run: Remove-Item -Force -ErrorAction SilentlyContinue $env:Wap_Project_Directory\GitHubActionsWorkflow.pfx

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: MSIX Package
          path: ${{ env.Wap_Project_Directory }}\AppPackages